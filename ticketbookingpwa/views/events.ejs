<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!--accessibility-->
  <meta name="description" content="Main page, booking screen, events display, logout, book confirmation">
  <title>Events â€¢ Tixster</title>
  <link rel="stylesheet" href="/css/events.css"> <!-- refer to events.css -->
  <link rel="manifest" href="/manifest.json">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.1/gsap.min.js"></script> <!-- GSAP for animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
  <header>
    <!-- Logo -->
    <div class="logo-container">
      <a href="/" class="backtoindex">
        <img src="/images/logo1.jpg" type="jpg" alt="Tixster Logo" class="logo">
      </a>
    </div>
    <h1>Tixster</h1>
    <% if (user) { %> <!-- if user is logged in -->
      <p class="welcome-message">Welcome, <%= user.name %> | <a href="/logout"
            class="switch-link-logout"><u><strong>Logout</strong></u></a></p>
      <!-- shows previous bookings for user -->
      <div class="booking-dropdown">
        <button class="dropdown-btn">Your Bookings <i class="fas fa-caret-down"></i></button>
        <div class="dropdown-content">
          <% if (userBookings.length> 0) { %>
            <% userBookings.forEach(booking=> { %>
              <p>
                <%= booking.seats %> seat(s) for <%= events.find(event=> event.id === booking.eventId)?.name || 'Event
                    Not Found' %>
              </p>
              <% }) %>
                <% } else { %>
                  <p>No bookings yet.</p>
                  <% } %>
        </div>
      </div>
      <% } else { %> <!--if user is not logged in -->
        <p class="auth-links"><a href="/signup"><u>Sign Up</u></a> | <a href="/login"><u>Login</u></a></p>
        <% } %>

          <!--search bar for events -->
          <section class="search-section">
            <form action="/events" method="GET" class="search-form">
              <input size="60" class="search" type="text" name="search" placeholder="Search for events"
                value="<%= searchQuery || '' %>">
              <button type="submit" alt="search-button" class="search-button">
                <i class="fas fa-search"></i>
              </button>
            </form>

            <div class="contact-link">
              <a class='cont-link' href="/contact">Contact Us</a>
            </div>
            <div class="aboutus-link">
              <a class=about-link href='/aboutus'>About Us</a>
            </div>
          </section>
  </header>

  <main>
    <!-- events section display -->
    <section class="events-section">
      <h2>Available Events</h2>
      <h3 class="limit">You are limited to 1 booking per account</h3>
      <% if (events.length> 0) { %> <!--making sure there are events if there are any events -->
        <% events.forEach(event=> { %>
          <div class="event-card">
            <h3 class="event-name">
              <%= event.name %>
            </h3> <!--event's name-->
            <div class="event-details">
              <div class="event-description">
                <p class="event-desc">
                  <%= event.description %>
                </p> <!-- Show event description -->
                <p class="seats-available">Seats available: <strong>
                    <%= event.seats %>
                  </strong></p> <!-- Show available seats -->
                <p class="event-price">Price: <strong>
                    <%= event.price %>
                  </strong></p> <!-- Show event price -->
              </div>
              <div class="event-booking">
                <% const userBooking=userBookings.find(booking=> booking.eventId === event.id); // Check if user has
                  already booked this event
                  %>
                  <p>
                    <% if (userBooking) { %>
                      You have made a previous booking for this event.
                      <% } else { %>
                        <% if (user) { %> <!--if  logged in, show booking form -->
                          <form action="/book/<%= event.id %>" method="POST" class="booking-form">
                            <input class="seats" type="number" name="seats" placeholder="Seats" min="1"
                              max="<%= event.seats %>" required>
                            <button type="submit" class="book-now-btn"><strong>Book Tickets</strong></button>
                          </form>
                          <% } else { %> <!-- If logged in then prompt to login before booking-->
                            <p class="login-prompt">Please <a href="/login"><u>login</u></a> to book this event.</p>
                            <% } %>
                              <% } %>
                  </p>
              </div>
            </div>
          </div>
          <% }) %>
            <% } else { %> <!--if no events found -->
              <p>No events available.</p>
              <% } %>
    </section>
  </main>

  <footer>
    <p>&copy; Tixster</p>
  </footer>

  <!-- service worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('../sw.js')
          .then((registration) => {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }

    // GSAP Animations
    window.addEventListener('load', () => {
      gsap.from("header", { opacity: 0, duration: 1, y: -50 });
      gsap.from(".events-section", { opacity: 0, duration: 1.5, y: 50, stagger: 0.3 });
      gsap.from(".book-now-btn", { opacity: 1, duration: 2, y: 20, stagger: 0.2 });
    });
  </script>
</body>

</html>